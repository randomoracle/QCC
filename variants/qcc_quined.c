/* Warning: Automatically generated code; do not modify */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

const char *get_self();

#define _QUINE_
#include <errno.h>
#include <stdbool.h>
#include <stdio.h>
#include <stdlib.h>

static const char *kUsage =
"Usage: qcc [options] <source file>\n"
"Options:\n"
"  -i  Suppress #include directives\n"
"  -p  Suppress function prototype\n"
"  -w  Suppress warning against modification\n"
"  -d  Define macro for conditional compilation\n"
#ifdef _QUINE_
"  -q  Output own source code\n"
#endif
 ;

static const char kWarning[] =
"/* Warning: Automatically generated code; do not modify */\n";

static const char kPreprocessorMacro[] = "#define _QUINE_\n";

static const char kPrologueHeaders[] =
"#include <stdlib.h>\n"
"#include <stdio.h>\n"
"#include <string.h>\n"
"\n";

static const char kProloguePrototype[] =
"const char *get_self();\n"
"\n";

static const char kHexDecodeHelper[] =
"size_t hex_decode(const char *input, char **output) {\n"
"  size_t l = strlen(input);\n"
"  char *decoded = *output = malloc(l / 2 + 1);\n"
"  while (*input) {\n"
"    unsigned char byte;\n"
"    sscanf(input, \"%2hhx\", &byte);\n"
"    *decoded++ = byte;\n"
"    input += 2;\n"
"  }\n"
"  *decoded = 0;\n"
"  return decoded - *output;\n"
"}\n";

static const char kSelfRef[] =
"const char *get_self() {\n"
"  static char *self;\n"
"  if (self == NULL) {\n"
"    char *decoded_prologue, *decoded_selfref;\n"
"    size_t c_prologue = hex_decode(prologue, &decoded_prologue);\n"
"    size_t c_selfref = hex_decode(selfref, &decoded_selfref);\n"
"    self = malloc(c_prologue + c_selfref + strlen(prologue) + strlen(selfref) + 0x1000);\n"
"    sprintf(self, \"%sconst char prologue[] = %c%s%c;\\nconst char selfref[] = %c%s%c;\\n\\n%s\",\n"
"            decoded_prologue, 34, prologue, 34, 34, selfref, 34, decoded_selfref);\n"
"    free(decoded_prologue), free(decoded_selfref);\n"
"  }\n"
"  return self;\n"
"}\n";

static bool
#ifdef _QUINE_
  kOutputSelf = false,
#endif
  kSuppressWarning = false,
  kSuppressInclude = false,
  kSuppressPrototype = false,
  kDefineMacro = false;

static const char *source;

int parse_arguments(int argc, char **argv) {
  if (argc == 1) return 0;

  for (int i = 1; i < argc; i++) {
    const char *argument = argv[i];
    if (argument[0] != '-') {
      if (source == NULL) {
        source = argv[i];
        continue;
      } else {
        fprintf(stderr, "Too many arguments\n");
        return __COUNTER__ + 1;
      }
    }

    if (argument[1] == '\0') {
      fprintf(stderr, "Empty option: %s\n", argument);
      return __COUNTER__ + 1;
    }
    for (int j = 1; argument[j]; j++) {
      switch (argv[i][j]) {
        case 'i':
          kSuppressInclude = true;
          break;
        case 'p':
          kSuppressPrototype = true;
          break;
        case 'w':
          kSuppressWarning = true;
          break;
        case 'd':
          kDefineMacro = true;
          break;
#ifdef _QUINE_
        case 'q':
          kOutputSelf = true;
          break;
#endif
        default:
          fprintf(stderr, "Unknown option: %s\n", argv[i]);
          return __COUNTER__ + 1;
      }
    }
  }

  return 0;
}

void output_hex(FILE *fp, const char *text) {
  while (*text)
    fprintf(fp, "%02x", *text++);
}

void synchronized_write(FILE *fp, const char *text) {
  printf("%s", text);
  output_hex(fp, text);
}

int quine_source(FILE *fp) {
  static const size_t kSpace = 0x1000;
  char *segment = malloc(kSpace);

  FILE *prologue = tmpfile();
  if (prologue == NULL) {
    fprintf(stderr, "error creating temporary file: %d\n", errno);
    return __COUNTER__ + 1;
  }

  if (!kSuppressWarning)    synchronized_write(prologue, kWarning);
  if (!kSuppressInclude)    synchronized_write(prologue, kPrologueHeaders);
  if (!kSuppressPrototype)  synchronized_write(prologue, kProloguePrototype);
  if (kDefineMacro)         synchronized_write(prologue, kPreprocessorMacro);

  while (fgets(segment, kSpace, fp))
    synchronized_write(prologue, segment);

  synchronized_write(prologue, "\n");
  synchronized_write(prologue, kHexDecodeHelper);
  synchronized_write(prologue, "\n");

  rewind(prologue);

  printf("const char prologue[] = \"");
  while (fgets(segment, kSpace, prologue))
    printf("%s", segment);
  printf("\";\n");

  printf("const char selfref[] = \"");
  output_hex(stdout, kSelfRef);
  printf("\";\n\n");

  printf("%s", kSelfRef);

  free(segment);
  fclose(prologue);
  return 0;
}

int main(int argc, char **argv) {
  int ecode = parse_arguments(argc, argv);

  if (ecode) {
    return ecode;
#ifdef _QUINE_
  } else if (kOutputSelf) {
    const char *self = get_self();
    printf("%s", self);
#endif
  } else if (source == NULL) {
    printf("%s", kUsage);
  } else {
    FILE *fp = fopen(source, "r");
    if (fp == NULL) {
      fprintf(stderr, "error opening source file: %s\n", source);
      ecode = errno;
    } else {
      ecode = quine_source(fp);
      fclose(fp);
    }
  }

  return ecode;
}

size_t hex_decode(const char *input, char **output) {
  size_t l = strlen(input);
  char *decoded = *output = malloc(l / 2 + 1);
  while (*input) {
    unsigned char byte;
    sscanf(input, "%2hhx", &byte);
    *decoded++ = byte;
    input += 2;
  }
  *decoded = 0;
  return decoded - *output;
}

const char prologue[] = "2f2a205761726e696e673a204175746f6d61746963616c6c792067656e65726174656420636f64653b20646f206e6f74206d6f64696679202a2f0a23696e636c756465203c7374646c69622e683e0a23696e636c756465203c737464696f2e683e0a23696e636c756465203c737472696e672e683e0a0a636f6e73742063686172202a6765745f73656c6628293b0a0a23646566696e65205f5155494e455f0a23696e636c756465203c6572726e6f2e683e0a23696e636c756465203c737464626f6f6c2e683e0a23696e636c756465203c737464696f2e683e0a23696e636c756465203c7374646c69622e683e0a0a73746174696320636f6e73742063686172202a6b5573616765203d0a2255736167653a20716363205b6f7074696f6e735d203c736f757263652066696c653e5c6e220a224f7074696f6e733a5c6e220a2220202d69202053757070726573732023696e636c75646520646972656374697665735c6e220a2220202d70202053757070726573732066756e6374696f6e2070726f746f747970655c6e220a2220202d7720205375707072657373207761726e696e6720616761696e7374206d6f64696669636174696f6e5c6e220a2220202d642020446566696e65206d6163726f20666f7220636f6e646974696f6e616c20636f6d70696c6174696f6e5c6e220a236966646566205f5155494e455f0a2220202d7120204f7574707574206f776e20736f7572636520636f64655c6e220a23656e6469660a203b0a0a73746174696320636f6e73742063686172206b5761726e696e675b5d203d0a222f2a205761726e696e673a204175746f6d61746963616c6c792067656e65726174656420636f64653b20646f206e6f74206d6f64696679202a2f5c6e223b0a0a73746174696320636f6e73742063686172206b50726570726f636573736f724d6163726f5b5d203d202223646566696e65205f5155494e455f5c6e223b0a0a73746174696320636f6e73742063686172206b50726f6c6f677565486561646572735b5d203d0a2223696e636c756465203c7374646c69622e683e5c6e220a2223696e636c756465203c737464696f2e683e5c6e220a2223696e636c756465203c737472696e672e683e5c6e220a225c6e223b0a0a73746174696320636f6e73742063686172206b50726f6c6f67756550726f746f747970655b5d203d0a22636f6e73742063686172202a6765745f73656c6628293b5c6e220a225c6e223b0a0a73746174696320636f6e73742063686172206b4865784465636f646548656c7065725b5d203d0a2273697a655f74206865785f6465636f646528636f6e73742063686172202a696e7075742c2063686172202a2a6f757470757429207b5c6e220a22202073697a655f74206c203d207374726c656e28696e707574293b5c6e220a22202063686172202a6465636f646564203d202a6f7574707574203d206d616c6c6f63286c202f2032202b2031293b5c6e220a2220207768696c6520282a696e70757429207b5c6e220a2220202020756e7369676e6564206368617220627974653b5c6e220a2220202020737363616e6628696e7075742c205c2225326868785c222c202662797465293b5c6e220a22202020202a6465636f6465642b2b203d20627974653b5c6e220a2220202020696e707574202b3d20323b5c6e220a2220207d5c6e220a2220202a6465636f646564203d20303b5c6e220a22202072657475726e206465636f646564202d202a6f75747075743b5c6e220a227d5c6e223b0a0a73746174696320636f6e73742063686172206b53656c665265665b5d203d0a22636f6e73742063686172202a6765745f73656c662829207b5c6e220a2220207374617469632063686172202a73656c663b5c6e220a2220206966202873656c66203d3d204e554c4c29207b5c6e220a222020202063686172202a6465636f6465645f70726f6c6f6775652c202a6465636f6465645f73656c667265663b5c6e220a222020202073697a655f7420635f70726f6c6f677565203d206865785f6465636f64652870726f6c6f6775652c20266465636f6465645f70726f6c6f677565293b5c6e220a222020202073697a655f7420635f73656c66726566203d206865785f6465636f64652873656c667265662c20266465636f6465645f73656c66726566293b5c6e220a222020202073656c66203d206d616c6c6f6328635f70726f6c6f677565202b20635f73656c66726566202b207374726c656e2870726f6c6f67756529202b207374726c656e2873656c6672656629202b20307831303030293b5c6e220a2220202020737072696e74662873656c662c205c222573636f6e737420636861722070726f6c6f6775655b5d203d202563257325633b5c5c6e636f6e737420636861722073656c667265665b5d203d202563257325633b5c5c6e5c5c6e25735c222c5c6e220a222020202020202020202020206465636f6465645f70726f6c6f6775652c2033342c2070726f6c6f6775652c2033342c2033342c2073656c667265662c2033342c206465636f6465645f73656c66726566293b5c6e220a222020202066726565286465636f6465645f70726f6c6f677565292c2066726565286465636f6465645f73656c66726566293b5c6e220a2220207d5c6e220a22202072657475726e2073656c663b5c6e220a227d5c6e223b0a0a73746174696320626f6f6c0a236966646566205f5155494e455f0a20206b4f757470757453656c66203d2066616c73652c0a23656e6469660a20206b53757070726573735761726e696e67203d2066616c73652c0a20206b5375707072657373496e636c756465203d2066616c73652c0a20206b537570707265737350726f746f74797065203d2066616c73652c0a20206b446566696e654d6163726f203d2066616c73653b0a0a73746174696320636f6e73742063686172202a736f757263653b0a0a696e742070617273655f617267756d656e747328696e7420617267632c2063686172202a2a6172677629207b0a20206966202861726763203d3d2031292072657475726e20303b0a0a2020666f722028696e742069203d20313b2069203c20617267633b20692b2b29207b0a20202020636f6e73742063686172202a617267756d656e74203d20617267765b695d3b0a2020202069662028617267756d656e745b305d20213d20272d2729207b0a20202020202069662028736f75726365203d3d204e554c4c29207b0a2020202020202020736f75726365203d20617267765b695d3b0a2020202020202020636f6e74696e75653b0a2020202020207d20656c7365207b0a2020202020202020667072696e7466287374646572722c2022546f6f206d616e7920617267756d656e74735c6e22293b0a202020202020202072657475726e205f5f434f554e5445525f5f202b20313b0a2020202020207d0a202020207d0a0a2020202069662028617267756d656e745b315d203d3d20275c302729207b0a202020202020667072696e7466287374646572722c2022456d707479206f7074696f6e3a2025735c6e222c20617267756d656e74293b0a20202020202072657475726e205f5f434f554e5445525f5f202b20313b0a202020207d0a20202020666f722028696e74206a203d20313b20617267756d656e745b6a5d3b206a2b2b29207b0a2020202020207377697463682028617267765b695d5b6a5d29207b0a202020202020202063617365202769273a0a202020202020202020206b5375707072657373496e636c756465203d20747275653b0a20202020202020202020627265616b3b0a202020202020202063617365202770273a0a202020202020202020206b537570707265737350726f746f74797065203d20747275653b0a20202020202020202020627265616b3b0a202020202020202063617365202777273a0a202020202020202020206b53757070726573735761726e696e67203d20747275653b0a20202020202020202020627265616b3b0a202020202020202063617365202764273a0a202020202020202020206b446566696e654d6163726f203d20747275653b0a20202020202020202020627265616b3b0a236966646566205f5155494e455f0a202020202020202063617365202771273a0a202020202020202020206b4f757470757453656c66203d20747275653b0a20202020202020202020627265616b3b0a23656e6469660a202020202020202064656661756c743a0a20202020202020202020667072696e7466287374646572722c2022556e6b6e6f776e206f7074696f6e3a2025735c6e222c20617267765b695d293b0a2020202020202020202072657475726e205f5f434f554e5445525f5f202b20313b0a2020202020207d0a202020207d0a20207d0a0a202072657475726e20303b0a7d0a0a766f6964206f75747075745f6865782846494c45202a66702c20636f6e73742063686172202a7465787429207b0a20207768696c6520282a74657874290a20202020667072696e74662866702c202225303278222c202a746578742b2b293b0a7d0a0a766f69642073796e6368726f6e697a65645f77726974652846494c45202a66702c20636f6e73742063686172202a7465787429207b0a20207072696e746628222573222c2074657874293b0a20206f75747075745f6865782866702c2074657874293b0a7d0a0a696e74207175696e655f736f757263652846494c45202a667029207b0a202073746174696320636f6e73742073697a655f74206b5370616365203d203078313030303b0a202063686172202a7365676d656e74203d206d616c6c6f63286b5370616365293b0a0a202046494c45202a70726f6c6f677565203d20746d7066696c6528293b0a20206966202870726f6c6f677565203d3d204e554c4c29207b0a20202020667072696e7466287374646572722c20226572726f72206372656174696e672074656d706f726172792066696c653a2025645c6e222c206572726e6f293b0a2020202072657475726e205f5f434f554e5445525f5f202b20313b0a20207d0a0a202069662028216b53757070726573735761726e696e67292020202073796e6368726f6e697a65645f77726974652870726f6c6f6775652c206b5761726e696e67293b0a202069662028216b5375707072657373496e636c756465292020202073796e6368726f6e697a65645f77726974652870726f6c6f6775652c206b50726f6c6f67756548656164657273293b0a202069662028216b537570707265737350726f746f7479706529202073796e6368726f6e697a65645f77726974652870726f6c6f6775652c206b50726f6c6f67756550726f746f74797065293b0a2020696620286b446566696e654d6163726f2920202020202020202073796e6368726f6e697a65645f77726974652870726f6c6f6775652c206b50726570726f636573736f724d6163726f293b0a0a20207768696c6520286667657473287365676d656e742c206b53706163652c20667029290a2020202073796e6368726f6e697a65645f77726974652870726f6c6f6775652c207365676d656e74293b0a0a202073796e6368726f6e697a65645f77726974652870726f6c6f6775652c20225c6e22293b0a202073796e6368726f6e697a65645f77726974652870726f6c6f6775652c206b4865784465636f646548656c706572293b0a202073796e6368726f6e697a65645f77726974652870726f6c6f6775652c20225c6e22293b0a0a2020726577696e642870726f6c6f677565293b0a0a20207072696e74662822636f6e737420636861722070726f6c6f6775655b5d203d205c2222293b0a20207768696c6520286667657473287365676d656e742c206b53706163652c2070726f6c6f67756529290a202020207072696e746628222573222c207365676d656e74293b0a20207072696e746628225c223b5c6e22293b0a0a20207072696e74662822636f6e737420636861722073656c667265665b5d203d205c2222293b0a20206f75747075745f686578287374646f75742c206b53656c66526566293b0a20207072696e746628225c223b5c6e5c6e22293b0a0a20207072696e746628222573222c206b53656c66526566293b0a0a202066726565287365676d656e74293b0a202066636c6f73652870726f6c6f677565293b0a202072657475726e20303b0a7d0a0a696e74206d61696e28696e7420617267632c2063686172202a2a6172677629207b0a2020696e742065636f6465203d2070617273655f617267756d656e747328617267632c2061726776293b0a0a20206966202865636f646529207b0a2020202072657475726e2065636f64653b0a236966646566205f5155494e455f0a20207d20656c736520696620286b4f757470757453656c6629207b0a20202020636f6e73742063686172202a73656c66203d206765745f73656c6628293b0a202020207072696e746628222573222c2073656c66293b0a23656e6469660a20207d20656c73652069662028736f75726365203d3d204e554c4c29207b0a202020207072696e746628222573222c206b5573616765293b0a20207d20656c7365207b0a2020202046494c45202a6670203d20666f70656e28736f757263652c20227222293b0a20202020696620286670203d3d204e554c4c29207b0a202020202020667072696e7466287374646572722c20226572726f72206f70656e696e6720736f757263652066696c653a2025735c6e222c20736f75726365293b0a20202020202065636f6465203d206572726e6f3b0a202020207d20656c7365207b0a20202020202065636f6465203d207175696e655f736f75726365286670293b0a20202020202066636c6f7365286670293b0a202020207d0a20207d0a0a202072657475726e2065636f64653b0a7d0a0a73697a655f74206865785f6465636f646528636f6e73742063686172202a696e7075742c2063686172202a2a6f757470757429207b0a202073697a655f74206c203d207374726c656e28696e707574293b0a202063686172202a6465636f646564203d202a6f7574707574203d206d616c6c6f63286c202f2032202b2031293b0a20207768696c6520282a696e70757429207b0a20202020756e7369676e6564206368617220627974653b0a20202020737363616e6628696e7075742c20222532686878222c202662797465293b0a202020202a6465636f6465642b2b203d20627974653b0a20202020696e707574202b3d20323b0a20207d0a20202a6465636f646564203d20303b0a202072657475726e206465636f646564202d202a6f75747075743b0a7d0a0a";
const char selfref[] = "636f6e73742063686172202a6765745f73656c662829207b0a20207374617469632063686172202a73656c663b0a20206966202873656c66203d3d204e554c4c29207b0a2020202063686172202a6465636f6465645f70726f6c6f6775652c202a6465636f6465645f73656c667265663b0a2020202073697a655f7420635f70726f6c6f677565203d206865785f6465636f64652870726f6c6f6775652c20266465636f6465645f70726f6c6f677565293b0a2020202073697a655f7420635f73656c66726566203d206865785f6465636f64652873656c667265662c20266465636f6465645f73656c66726566293b0a2020202073656c66203d206d616c6c6f6328635f70726f6c6f677565202b20635f73656c66726566202b207374726c656e2870726f6c6f67756529202b207374726c656e2873656c6672656629202b20307831303030293b0a20202020737072696e74662873656c662c20222573636f6e737420636861722070726f6c6f6775655b5d203d202563257325633b5c6e636f6e737420636861722073656c667265665b5d203d202563257325633b5c6e5c6e2573222c0a2020202020202020202020206465636f6465645f70726f6c6f6775652c2033342c2070726f6c6f6775652c2033342c2033342c2073656c667265662c2033342c206465636f6465645f73656c66726566293b0a2020202066726565286465636f6465645f70726f6c6f677565292c2066726565286465636f6465645f73656c66726566293b0a20207d0a202072657475726e2073656c663b0a7d0a";

const char *get_self() {
  static char *self;
  if (self == NULL) {
    char *decoded_prologue, *decoded_selfref;
    size_t c_prologue = hex_decode(prologue, &decoded_prologue);
    size_t c_selfref = hex_decode(selfref, &decoded_selfref);
    self = malloc(c_prologue + c_selfref + strlen(prologue) + strlen(selfref) + 0x1000);
    sprintf(self, "%sconst char prologue[] = %c%s%c;\nconst char selfref[] = %c%s%c;\n\n%s",
            decoded_prologue, 34, prologue, 34, 34, selfref, 34, decoded_selfref);
    free(decoded_prologue), free(decoded_selfref);
  }
  return self;
}
